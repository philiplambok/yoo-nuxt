#!/bin/bash
# Rebuild Docker image with fresh dependencies

# Source common functions
source "$(dirname "$0")/_common"
check_docker

echo "🔄 Rebuilding Docker image..."
echo "💡 This will update dependencies and rebuild the image"
echo ""

# First, update the lockfile locally
echo "📦 Updating pnpm lockfile..."
pnpm install

echo ""
echo "🔨 Building Docker image..."
echo "💡 Use './dx/rebuild --no-cache' for fresh build without cache"

if [ "$1" = "--no-cache" ]; then
    echo "🧹 Building without cache..."
    docker build --no-cache -f dx/Dockerfile -t yoo-nuxt-todo:dev .
else
    docker build -f dx/Dockerfile -t yoo-nuxt-todo:dev .
fi

if [ $? -eq 0 ]; then
    echo ""
    echo "✅ Rebuild complete! Docker image updated with latest dependencies."
    echo "🚀 You can now run './dx/dev' or './dx/test' with the updated image."
else
    echo ""
    echo "❌ Rebuild failed. Check the error messages above."
    exit 1
fi