#!/bin/bash
# Rebuild Docker image with fresh dependencies

# Source common functions
source "$(dirname "$0")/_common"
check_docker

echo "ğŸ”„ Rebuilding Docker image..."
echo "ğŸ’¡ This will update dependencies and rebuild the image"
echo ""

# First, update the lockfile locally
echo "ğŸ“¦ Updating pnpm lockfile..."
pnpm install

echo ""
echo "ğŸ”¨ Building Docker image..."
echo "ğŸ’¡ Use './dx/rebuild --no-cache' for fresh build without cache"

if [ "$1" = "--no-cache" ]; then
    echo "ğŸ§¹ Building without cache..."
    docker build --no-cache -f dx/Dockerfile -t yoo-nuxt-todo:dev .
else
    docker build -f dx/Dockerfile -t yoo-nuxt-todo:dev .
fi

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… Rebuild complete! Docker image updated with latest dependencies."
    echo "ğŸš€ You can now run './dx/dev' or './dx/test' with the updated image."
else
    echo ""
    echo "âŒ Rebuild failed. Check the error messages above."
    exit 1
fi